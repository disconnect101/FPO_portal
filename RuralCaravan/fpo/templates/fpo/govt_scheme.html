{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Govt Scheme</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="{% static 'css/mdb.min.css' %}" rel="stylesheet">
    <!--  custom styles  -->
    <link href="{% static 'css/style.min.css' %}" rel="stylesheet">
    <!-- Charts Js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.css" crossorigin="anonymous"></link>
    <style type="text/css">

      html,
      body,
      header,
      .carousel {
        height: 60vh;
      }

      @media (max-width: 740px) {
        html,
        body,
        header,
        .carousel {
          height: 100vh;
        }
      }

      @media (min-width: 800px) and (max-width: 850px) {
        html,
        body,
        header,
        .carousel {
          height: 100vh;
        }
      }

      @media (min-width: 800px) and (max-width: 850px) {
              .navbar:not(.top-nav-collapse) {
                  background:#295e10!important;
              }
          }

      input.rsvp {
        background-color: #4caf50;
        width: 14px;
        height: 14px;
      }

      #pushButton {
        background-color: white;
        border: 1px solid #d62828;
        color: #d62828;
        border-radius: 0.2rem;
        font-size: 1.4rem;
        padding: 0.2rem 1rem;
        transition: all 0.5s;
      }

      #pushButton:hover {
        background-color: #d62828;
        border: 1px solid white;
        color: white;
      }

      #pushButton:focus, #pushButton:active, #pushButton:selected {
        border: 1px solid #d62828;
      }

      input.selectAll {
        width: 16px;
        height: 16px;
      }

      .card {
        cursor: pointer;
      }

    </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">

      <!-- Brand -->
      <a class="navbar-brand" href="{% url 'home' %}">
        <strong>FPO PORTAL</strong>
      </a>

      <!-- Collapse -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Links -->
      <div class="collapse navbar-collapse" id="navbarSupportedContent">

        <!-- Left -->
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'meetings' %}" >Meetings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'plans' %}">Plans</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="{% url 'govtschemes' %}" >Government Schemes</a>
          </li>
             <li class="nav-item">
            <a class="nav-link" href="{% url 'produce' %}" >Production</a>
          </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'FPOLedger'%}">Ledger</a>
            </li>
        </ul>

        <!-- Right -->
        <ul class="navbar-nav nav-flex-icons">
            <li class="nav-item">
            <a href="{% url 'add_user' %}" class="nav-link" data-toggle="tooltip" title="Add New User">
             <i class="fas fa-user-plus"></i>
            </a>
          </li>
             <li class="nav-item">
            <a href="{% url 'transaction'%}" class="nav-link" data-toggle="tooltip" title="Transactions">
             <i class="fas fa-rupee-sign"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'orders' %}" class="nav-link" data-toggle="tooltip" title="Orders">
             <i class="fas fa-shopping-cart"></i>
            </a>
          </li>
             <li class="nav-item">
            <a href="{% url 'products' %}" class="nav-link" data-toggle="tooltip" title="Products">
             <i class="fas fa-shopping-basket"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'fpo_statistics' %}" class="nav-link" data-toggle="tooltip" title="Statistics">
             <i class="fas fa-chart-bar"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'members' %}" class="nav-link border border-light rounded"
             >
              <i class="fas fa-user"></i>Members
            </a>
          </li>
		  <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}" >Logout</a>
          </li>


        </ul>

      </div>

    </div>
  </nav>
  <!-- Navbar -->



  <!--Main layout-->
<main style="padding-top: 8rem;">
    <div class="container" >
        <div class="row">
            <div class="col-12">


                <h1 style="text-align: center;" class="green-text mt-0 mb-3">{{data.name}}</h1>
                <hr style="margin: auto; width: 6rem; border: 2px solid #4caf50; border-radius: 20rem;">
                <br>
                <p style="text-align: right; text-transform: uppercase; font-size: 1.2rem;" class="green-text"><strong>{{data.date}}</strong></p>
                <h4 style="text-align: left;"><strong class="green-text">Details:</strong> {{data.description}}</h4>
                <br>
            </div>
            <div class="col-2"></div>
            <div class="col-8">
                <h1 style="text-align: center;" class="green-text">Reach By Villages</h1>
                <canvas id="myChart3" width="100" height="60"></canvas>
            </div>
        </div>
        <hr style="margin: 4rem;">
    </div>
    <div style="width: 80%; margin: 2rem auto;">
    <div style="text-align: center;">
        <i class="fas fa-users fa-4x green-text mb-3" style="opacity: 0.2"></i>
    </div>
    <h1 style="text-align: center; margin-bottom: 1.6rem; color: #4caf50">Famers</h1>
        <hr style="margin: 2rem auto; width: 6rem; border: 2px solid lightgray; border-radius: 20rem;">
        <div class="text-right">
         <button id="pushButton" >Sign Up</button>
        </div>
        {% if specials %}
        <h1 class="green-text mt-4">Critical Villages</h1>
        <hr style="margin: 0; width: 4rem; border: 2px solid #4caf50; border-radius: 20rem;">
        {% for village in specials %}
        <div class="row">
            <button class="btn btn-outline-success mb-4 mt-4" style="border-color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important; color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important" type="button" data-toggle="collapse" data-target="#village{{village.locality_id}}" aria-expanded="false" aria-controls="village{{village.locality_id}}">
                <h4><i class="fas fa-map-marker-alt"></i> {{village.locality_name}}</h4>
            </button>
        </div>
            <div class="collapse" id="village{{village.locality_id}}"> 
                <h4><strong class="green-text">Reach At</strong> +919999999991</h4>
                <div>
                  <span style="font-size: 1.4rem;" class="mr-1 green-text"><strong>Select All</strong> </span>
                  <input type="checkbox" class="selectAll">
                </div>
                <div class="mt-2">
                  <span style="font-size: 1.2rem; border: 1px solid {% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important; padding: 0.2rem 0.8rem; border-radius: 0.2rem; color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important"><strong>Scheme Reach {{village.engagement}}%</strong></span>
                </div>
                <div class="row mt-4">
                {% for token in village.farmers %}
                    <div class="col-lg-2 col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title green-text">{{token.farmer}}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">{{token.locality}}</h6>
                                <div>
                                  <span style="font-size: 1rem;" class="mr-1">Sign Up</span>
                                  <input type="checkbox" class="rsvp" name="id" value="{{token.id}}">
                                </div>
                                <a href="#" class="card-link">
                                    {% if token.smartphone_type == "Smartphone" %}
                                    <i class="fas fa-mobile fa-2x float-right green-text" ></i>
                                    {% elif token.smartphone_type == "Featurephone" %}
                                    <i class="fas fa-phone fa-2x float-right green-text" ></i>
                                    {% else %}
                                    <i class="fas fa-phone-slash fa-2x float-right green-text"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        {% endfor %}
        {% endif %}
        {% if villages %}
        <h1 class="green-text mt-4">Villages</h1>
        <hr style="margin: 0; width: 4rem; border: 2px solid #4caf50; border-radius: 20rem;">
        {% for village in villages %}
        <div class="row">
            <button class="btn btn-outline-success mb-4 mt-4" style="border-color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important; color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important" type="button" data-toggle="collapse" data-target="#village{{village.locality_id}}" aria-expanded="false" aria-controls="village{{village.locality_id}}">
                <h4><i class="fas fa-map-marker-alt"></i> {{village.locality_name}}</h4>
            </button>
        </div>
            <div class="collapse" id="village{{village.locality_id}}"> 
                <h4><strong class="green-text">Reach At</strong> +919999999991</h4>
                <div>
                  <span style="font-size: 1.4rem;" class="mr-1 green-text"><strong>Select All</strong> </span>
                  <input type="checkbox" class="selectAll">
                </div>
                <div class="mt-2">
                  <span style="font-size: 1.2rem; border: 1px solid {% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important; padding: 0.2rem 0.8rem; border-radius: 0.2rem; color:{% if village.engagement > 50 %}#2a9d8f {% elif village.engagement < 35 %} #e76f51 {% else %} #e9c46a {% endif %}!important"><strong>Scheme Reach {{village.engagement}}%</strong></span>
                </div>
                <div class="row mt-4">
                {% for token in village.farmers %}
                    <div class="col-lg-2 col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title green-text">{{token.farmer}}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">{{token.locality}}</h6>
                                <div>
                                  <span style="font-size: 1rem;" class="mr-1">RSVP</span>
                                  <input type="checkbox" class="rsvp" name="id" value="{{token.id}}">
                                </div>
                                <a href="#" class="card-link">
                                    {% if token.smartphone_type == "Smartphone" %}
                                    <i class="fas fa-mobile fa-2x float-right green-text" ></i>
                                    {% elif token.smartphone_type == "Featurephone" %}
                                    <i class="fas fa-phone fa-2x float-right green-text" ></i>
                                    {% else %}
                                    <i class="fas fa-phone-slash fa-2x float-right green-text"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            </div>
        {% endfor %}
        {% endif %}
    </div>
</main>
  <!--Main layout-->

  <!--Footer-->
  <footer class="page-footer text-center font-small mt-4 wow fadeIn" >



    <!--Copyright-->
    <div class="footer-copyright py-3">
      © 2020 Copyright:
  Rural Caravan
    </div>
    <!--/.Copyright-->

  </footer>
  <!--/.Footer-->

    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="{% static 'js/popper.min.js' %}"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="{% static 'js/mdb.min.js' %}"></script>
      <!-- Initializations -->
  <script type="text/javascript">
    // Animations initialization
    //new WOW().init();

    var villageNames = {{ village_names|safe }};
    var villageTotal = {{ village_total|safe }};
    var villagePopulation = {{ village_population|safe }}
    

    var backgroundColor = [];
    var borderColor = [];
    for(let i = 0; i < villageTotal.length; i++){
        let eng = villageTotal[i];
        if(eng > 75) {
            backgroundColor.push('rgba(75, 192, 192, 0.2)');
            borderColor.push('rgba(75, 192, 192, 1)');
        } else if (eng < 35) {
            backgroundColor.push('rgba(255, 99, 132, 0.2)');
            borderColor.push('rgba(255, 99, 132, 1)');
        } else {
            backgroundColor.push('rgba(255, 206, 86, 0.2)');
            borderColor.push('rgba(255, 206, 86, 1)');
        }
    }


    var ctx3 = document.getElementById('myChart3').getContext('2d');
    var myChart3 = new Chart(ctx3, {
        type: 'bar',
        data: {
        labels: villageNames,
        datasets: [{
            label: 'Percentage Reach for Every Village',
            data: villageTotal,
            backgroundColor: backgroundColor,
            borderColor: borderColor,
            borderWidth: 1
        }]
    },
        options: {
             scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true,
                    suggestedMax: 100
                }
            }]
        }
        }
    });



    // For getting the inputs

    document.querySelector('#pushButton').addEventListener('click', function() {
        var inputs = document.querySelectorAll('.rsvp');
        var village_name_selections = villageNames;
        var village_total_selections = villageTotal;

    
        selected_inputs = [];
        for(let i = 0; i < inputs.length; i++){
          if(inputs[i].checked){
            selected_inputs.push(eval(inputs[i].value));

            village_id = (inputs[i].parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute('id'));
            var buttons = document.querySelectorAll('button');
            for(let i = 0; i < buttons.length; i++){
                if(buttons[i].getAttribute('data-target') === `#${village_id}`){
                    village_name = (buttons[i].textContent.trim());
                }
            }

            var index = village_name_selections.indexOf(village_name);
            village_total_selections[index] += ((1/villagePopulation[village_name]).toFixed(2))*100;
            
            let data = {
                "farmer_ids": selected_inputs
            }

        let url = `${window.location.origin}${window.location.pathname}/add/`;
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            
            const json_data = JSON.stringify(data);

            const headers = {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                "X-CSRFToken": csrftoken
            }
            
            fetch(url, {method: 'post', headers: headers, body: json_data})
                .then(function(response) {
                    if(response.status===200){
                        for(let i = 0; i < inputs.length; i++){
                          if(inputs[i].checked){
                            inputs[i].parentNode.parentNode.parentNode.parentNode.remove();
                          }
                        }
                        response.json().then(function(data){
                            console.log(data);
                        })
                    }
                })
                .catch(function(err) {
                    console.log('The errror is', err);
                });




          }
        }

        backgroundColor = [];
        borderColor = [];

        for(let i = 0; i < villageTotal.length; i++){
        let eng = villageTotal[i];
        if(eng > 75) {
                backgroundColor.push('rgba(75, 192, 192, 0.2)');
                borderColor.push('rgba(75, 192, 192, 1)');
            } else if (eng < 35) {
                backgroundColor.push('rgba(255, 99, 132, 0.2)');
                borderColor.push('rgba(255, 99, 132, 1)');
            } else {
                backgroundColor.push('rgba(255, 206, 86, 0.2)');
                borderColor.push('rgba(255, 206, 86, 1)');
            }
        }
        myChart3.data.datasets[0].backgroundColor = backgroundColor;
        myChart3.data.datasets[0].borderColor = borderColor;

        myChart3.update();

        var selectAllLeaders = document.querySelectorAll('input.selectAll');
        for(let i = 0; i < selectAllLeaders.length; i++){
          selectAllLeaders[i].checked = false;
        }

    });


    // Select All for leaders 
    var selectAllLeaders = document.querySelectorAll('input.selectAll');
    for(let i = 0; i < selectAllLeaders.length; i++){
      selectAllLeaders[i].addEventListener('change', function() {
        var rsvp_inputs = selectAllLeaders[i].parentNode.nextElementSibling.nextElementSibling.children;
        for(let j = 0; j < rsvp_inputs.length; j++){
          rsvp_inputs[j].querySelector('input.rsvp').checked = selectAllLeaders[i].checked;
        }
      });
    }

    // For easier card selection
    var cards = document.querySelectorAll('.card');
    for(let i = 0; i < cards.length; i++){
        cards[i].addEventListener('click', function() {
            cards[i].querySelector('input.rsvp').checked = !cards[i].querySelector('input.rsvp').checked;
        });
    }

  </script>
</body>

</html>
