{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Meetings</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="{% static 'css/mdb.min.css' %}" rel="stylesheet">
    <!--  custom styles  -->
    <link href="{% static 'css/style.min.css' %}" rel="stylesheet">
    <!-- Charts Js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.css" crossorigin="anonymous"></link>
    <style type="text/css">

      html,
      body,
      header,
      .carousel {
        height: 60vh;
      }

      @media (max-width: 740px) {
        html,
        body,
        header,
        .carousel {
          height: 100vh;
        }
      }

      @media (min-width: 800px) and (max-width: 850px) {
        html,
        body,
        header,
        .carousel {
          height: 100vh;
        }
      }

      @media (min-width: 800px) and (max-width: 850px) {
              .navbar:not(.top-nav-collapse) {
                  background:#295e10!important;
              }
          }

      input.marker {
        background-color: #4caf50;
        width: 20px;
        height: 20px;
      }

      #pushButton {
        background-color: white;
        border: 1px solid rgba(78, 205, 196, 1);
        color: rgba(78, 205, 196, 1);
        border-radius: 0.2rem;
        font-size: 1.4rem;
        padding: 0.2rem 1rem;
        transition: all 0.5s;
      }

      #pushButton:hover {
        background-color: rgba(78, 205, 196, 1);
        border: 1px solid white;
        color: white;
      }

      #pushButton:focus, #pushButton:active, #pushButton:selected {
        border: 1px solid #d62828;
      }

      input.selectAll {
        width: 16px;
        height: 16px;
      }

    .card:hover {
        cursor: pointer;
    }

    </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">

      <!-- Brand -->
      <a class="navbar-brand" href="{% url 'home' %}" target="_blank">
        <strong>FPO PORTAL</strong>
      </a>

      <!-- Collapse -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Links -->
      <div class="collapse navbar-collapse" id="navbarSupportedContent">

        <!-- Left -->
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="{% url 'meetings' %}" >Meetings</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="{% url 'plans' %}" >Plans</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="{% url 'govtschemes' %}" >Government Schemes</a>
          </li>
        </ul>

        <!-- Right -->
        <ul class="navbar-nav nav-flex-icons">
          <li class="nav-item">
            <a href="orders.html" class="nav-link" >
             <i class="fas fa-shopping-cart"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="statistics.html" class="nav-link" >
             <i class="fas fa-chart-bar"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'members' %}" class="nav-link border border-light rounded"
              target="_blank">
              <i class="fas fa-user"></i>Members
            </a>
          </li>
		   <li class="nav-item">
            <a class="nav-link" href="{% url 'login' %}" >Logout</a>
          </li>
        </ul>


      </div>

    </div>
  </nav>
  <!-- Navbar -->



  <!--Main layout-->
<main style="padding-top:10%">
    <div class="container" >
        <div class="row">
            <div class="col-md-12 col-lg-6">
                <p style="text-align: left; opacity: 0.2" class="mb-0"><strong>ORGANISED BY</strong></p>
                <h1 style="text-align: left;" class="green-text mt-0 mb-3">{{data.organiser}}</h1>
                <hr style="margin: 0; width: 4rem; border: 2px solid #4caf50; border-radius: 20rem;">
                <br>
                <p style="text-align: right; text-transform: uppercase; font-size: 1.2rem; color: red;" class="green-text"><strong style="color: red; border: 1px solid red; padding: 0.2rem 0.8rem; border-radius: 0.2rem;">ACTIVE</strong></p>
                <h4 style="text-align: left;"><strong class="green-text">Agenda:</strong> {{data.agenda}}</h4>
                <br>
                <p>
                    <span style="font-size: 1.3rem;" class="green-text"><strong>Details:</strong></span> {{data.description}}
                </p>    
                <h5 style="text-align: left;"><strong class="green-text">Time:</strong> {{data.time}}</h5>
                <h5 style="text-align: left;"><strong class="green-text">Venue:</strong> {{data.venue}}</h5>
            </div>
            <div class="col-md-12 col-lg-6">
                <h1 style="text-align: center;" class="green-text mb-4">Turn Out</h1>
                <canvas id="myChart" width="100" height="100"></canvas>
            </div>
        </div>
        <hr style="margin: 4rem;">
    </div>
    <div style="width: 80%; margin: 2rem auto;">
    <div style="text-align: center;">
        <i class="fas fa-clipboard fa-4x green-text mb-3" style="opacity: 0.2"></i>
    </div>
    <h1 style="text-align: center; margin-bottom: 1.6rem; color: #4caf50">Attendance</h1>
        <hr style="margin: 2rem auto; width: 6rem; border: 2px solid lightgray; border-radius: 20rem;">
        <div class="text-right">
         <button id="pushButton">Mark Attendance</button>
        </div>
        <h1 class="green-text mt-4 mb-2">Farmers</h1>
        <hr style="margin: 0; width: 4rem; border: 2px solid #4caf50; border-radius: 20rem;">
        <div class="row mt-4">
            {% for token in farmers %}
            <div class="col-lg-2 col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title green-text">{{token.farmer}}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{token.locality}}</h6>
                        <a class="card-link">
                          <input type="checkbox" class="marker mt-2" name="id" value="{{token.id}}">
                        </a>
                        <a class="card-link">
                            {% if token.smartphone_type == "Smartphone" %}
                            <i class="fas fa-mobile fa-2x green-text float-right" style="color: gray;"></i>
                            {% elif token.smartphone_type == "Featurephone" %}
                            <i class="fas fa-phone fa-2x green-text float-right" style="color: gray;"></i>
                            {% else %}
                            <i class="fas fa-phone-slash fa-2x green-text float-right" style="color: gray;"></i>
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</main>
  <!--Main layout-->

  <!--Footer-->
  <footer class="page-footer text-center font-small mt-4 wow fadeIn" >



    <!--Copyright-->
    <div class="footer-copyright py-3">
      Â© 2020 Copyright:
  Rural Caravan
    </div>
    <!--/.Copyright-->

  </footer>
  <!--/.Footer-->

    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="{% static 'js/popper.min.js' %}"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="{% static 'js/mdb.min.js' %}"></script>
      <!-- Initializations -->
  <script type="text/javascript">
    // Animations initialization
    new WOW().init();

    var present = {{present}};
    var absent = {{absent}};


    // Chart js initialisation
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'pie',
        data: {
            datasets: [{
                data: [present, absent],
                backgroundColor: [
                'rgba(78, 205, 196, 0.4)',
                'rgba(255, 107, 107, 0.4)',
                ],
                borderColor: [
                'rgba(78, 205, 196, 1)',
                'rgba(255, 107, 107, 1)',]
            }],
            labels: ['Present', 'Absent']
        },
        options: {}
    });

    // For getting the inputs
    document.querySelector('#pushButton').addEventListener('click', function() {
        var inputs = document.querySelectorAll('.marker');
    
        selected_inputs = [];
        for(let i = 0; i < inputs.length; i++){
          if(inputs[i].checked){
            selected_inputs.push(inputs[i].value);
          }
        }

        
        let data = {
                "token_ids": selected_inputs
            }
        let url = `${window.location.origin}/fpo/mark_attendance/`;
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            
            const json_data = JSON.stringify(data);

            const headers = {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                "X-CSRFToken": csrftoken
            }
            
            fetch(url, {method: 'post', headers: headers, body: json_data})
                .then(function(response) {
                    if(response.status===200){
                        for(let i = 0; i < inputs.length; i++){
                          if(inputs[i].checked){
                            inputs[i].parentNode.parentNode.parentNode.parentNode.remove();
                          }
                        }
                        response.json().then(function(data){
                            console.log(data);
                        })
                    }
                })
                .catch(function(err) {
                    console.log('The errror is', err);
                });


        present += selected_inputs.length;
        absent -= selected_inputs.length;
        
        myChart.data.datasets[0].data = [present, absent];
        myChart.update();

    });


    // For easier card selection
    var cards = document.querySelectorAll('.card');
    for(let i = 0; i < cards.length; i++){
        cards[i].addEventListener('click', function() {
            cards[i].querySelector('input.marker').checked = !cards[i].querySelector('input.marker').checked;
        });
    }

  </script>
</body>

</html>
